name: Create Bug Report

on:
  workflow_dispatch:
    inputs:
      bug_report_url:
        description: "Bug report URL or UUID"
        required: true
        type: string

jobs:
  create-bug-report:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: 1.3.1

      - name: Install dependencies
        run: bun install

      - name: Run bug report script
        id: bug_report
        run: |
          output=$(bun run bug-report-with-test "${{ github.event.inputs.bug_report_url }}" 2>&1)
          echo "$output"

          # Extract bug report number from output
          bug_num=$(echo "$output" | grep -oP 'Bug report "\K\d+' || echo "")
          echo "bug_number=$bug_num" >> $GITHUB_OUTPUT

      - name: Get created files info
        id: files_info
        run: |
          # Find the bug report number from the new test file
          test_file=$(git status --porcelain | grep "tests/bugs/bugreport" | head -1 | awk '{print $2}')
          if [ -n "$test_file" ]; then
            bug_num=$(echo "$test_file" | grep -oP 'bugreport\K\d+')
            echo "bug_number=$bug_num" >> $GITHUB_OUTPUT
            echo "test_file=$test_file" >> $GITHUB_OUTPUT
          fi

      - name: Create branch and commit
        id: create_branch
        run: |
          bug_num="${{ steps.files_info.outputs.bug_number }}"
          branch_name="bugreport${bug_num}"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git checkout -b "$branch_name"
          git add .
          git commit -m "add bugreport${bug_num}"
          git push origin "$branch_name"

          echo "branch_name=$branch_name" >> $GITHUB_OUTPUT

      - name: Create Pull Request
        id: create_pr
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          bug_num="${{ steps.files_info.outputs.bug_number }}"
          branch_name="${{ steps.create_branch.outputs.branch_name }}"

          pr_url=$(gh pr create \
            --title "Add bug report ${bug_num}" \
            --body "Automatically created bug report from URL: ${{ github.event.inputs.bug_report_url }}" \
            --head "$branch_name" \
            --base main)

          echo "pr_url=$pr_url" >> $GITHUB_OUTPUT
          echo ""
          echo "=========================================="
          echo "Pull Request created: $pr_url"
          echo "=========================================="
